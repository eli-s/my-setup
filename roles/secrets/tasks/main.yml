---
- name: Ensure sops age key directory exists
  ansible.builtin.file:
    path: "{{ ansible_user_dir }}/.config/sops/age"
    state: directory
    mode: '0700'

- name: Check if age key exists
  ansible.builtin.stat:
    path: "{{ ansible_user_dir }}/.config/sops/age/keys.txt"
  register: age_key

- name: Prompt for age key if it does not exist
  ansible.builtin.pause:
    prompt: |
      Age key not found at ~/.config/sops/age/keys.txt
      
      Options:
        1. Copy your key there manually and re-run
        2. Import from backup (1Password, USB, etc...)
      
      Press Enter to continue after adding your key, or Ctrl+C to abort
  when: not age_key.stat.exists

- name: Re-check for age key after prompt
  ansible.builtin.stat:
    path: "{{ ansible_user_dir }}/.config/sops/age/keys.txt"
  register: age_key_recheck
  when: not age_key.stat.exists

- name: Decrypt common secrets
  ansible.builtin.shell: |
    export SOPS_AGE_KEY_FILE="{{ ansible_user_dir }}/.config/sops/age/keys.txt"
    sops -d {{ playbook_dir }}/secrets/common.yml > /tmp/secrets_common.yml
  when: age_key.stat.exists or age_key_recheck.stat.exists | default(false)

- name: Load common secrets
  ansible.builtin.include_vars:
    file: /tmp/secrets_common.yml
    name: secrets
  when: age_key.stat.exists or age_key_recheck.stat.exists | default(false)

- name: Clean up decrypted file
  ansible.builtin.file:
    path: /tmp/secrets_common.yml
    state: absent

# --- Use secrets ---

- name: Create .ssh directory
  ansible.builtin.file:
    path: "{{ ansible_user_dir }}/.ssh"
    state: directory
    mode: '0700'

- name: Install SSH private key
  ansible.builtin.copy:
    content: "{{ secrets.ssh_keys.personal.private }}"
    dest: "{{ ansible_user_dir }}/.ssh/id_ed25519"
    mode: '0600'
  when: secrets.ssh_keys.personal.private is defined

- name: Install SSH public key
  ansible.builtin.copy:
    content: "{{ secrets.ssh_keys.personal.public }}"
    dest: "{{ ansible_user_dir }}/.ssh/id_ed25519.pub"
    mode: '0644'
  when: secrets.ssh_keys.personal.public is defined

- name: Configure git credentials
  ansible.builtin.template:
    src: gitconfig.j2
    dest: "{{ ansible_user_dir }}/.gitconfig"
    mode: '0644'
  when: secrets.git_user_name is defined